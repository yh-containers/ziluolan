<?php
namespace frontend\controllers;


use yii\web\Controller;

class CommonController extends Controller
{
    public $user_id = 0;

    public $is_need_login = true;
    protected $ignore_action = '';


    /**
     *
     * @var \yii\web\Request
     * */
    public $request;


    public function init()
    {
        parent::init();
        $this->request = \Yii::$app->request;
        if(\Yii::$app->session->has(\common\models\User::USER_SESSION_LOGIN_INFO)){
            $user_info = \Yii::$app->session->get(\common\models\User::USER_SESSION_LOGIN_INFO);
            $this->user_id = empty($user_info['user_id'])?0:$user_info['user_id'];
            if(empty($this->user_id)){
                //销毁session存在的数据
                \Yii::$app->session->remove(\common\models\User::USER_SESSION_LOGIN_INFO);
            }
        }
    }

    public function beforeAction($action)
    {
        parent::beforeAction($action);
        if($this->is_need_login){
            if(!$this->user_id && strpos($this->ignore_action,$action->id)===false){
                if($this->request->isAjax){
                    //需要登录才能访问
                    \Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;
                    \Yii::$app->response->data = array(
                        'code' => -1,
                        'msg' => '请先登录',
                        'url' => \yii\helpers\Url::to(['index/index'])
                    );
                    return false;
                }else{
                    //需要登录才能访问
                    $this->redirect(\yii\helpers\Url::to(['index/index']));
                    return false;
                }
            }
        }


        return true; // TODO: Change the autogenerated stub
    }


}